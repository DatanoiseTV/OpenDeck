name: Code formatting

on: [push]

jobs:
  format:
    name: Code formatting
    runs-on: ubuntu-20.04
    steps:
       - name: Pull the repository
         uses: actions/checkout@v1
         with:
          submodules: true
       - name: Prepare env
         run: |
           sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)"
           sudo apt install clang-format-11
           sudo touch /usr/bin/avrdude && sudo chmod +x /usr/bin/avrdude
           sudo touch /usr/bin/srec_cat && sudo chmod +x /usr/bin/srec_cat
           sudo touch /usr/bin/avr-gcc && sudo chmod +x /usr/bin/avr-gcc
           sudo touch /usr/bin/avr-g++ && sudo chmod +x /usr/bin/avr-g++
           sudo touch /usr/bin/arm-none-eabi-gcc && sudo chmod +x /usr/bin/arm-none-eabi-gcc
           sudo touch /usr/bin/arm-none-eabi-g++ && sudo chmod +x /usr/bin/arm-none-eabi-g++
           sudo touch /usr/bin/gdb && sudo chmod +x /usr/bin/gdb
           curl -L https://github.com/mikefarah/yq/releases/download/3.4.1/yq_linux_amd64 > yq
           chmod +x yq
           sudo mv yq /usr/local/bin/yq
       - name: Format
         run: |
           clang-format --version
           cd src
           make format CF_FAIL_ON_DIFF=1 CLANG_FORMAT=clang-format-11
           cd ../tests
           make format CF_FAIL_ON_DIFF=1 CLANG_FORMAT=clang-format-11
